name: Instruction Log Capture

on:
  workflow_dispatch:
    inputs:
      actor:
        description: API actor invoking the instruction
        required: true
      action:
        description: Instruction description
        required: true
      result:
        description: Result summary
        required: false

jobs:
  append-log:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Append instruction event
        run: |
          mkdir -p governance/control
          echo '{"timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'", "actor": "${{ github.event.inputs.actor }}", "action": "${{ github.event.inputs.action }}", "result": "${{ github.event.inputs.result }}"}' >> governance/control/instruction-log.jsonl
      - name: Build manifest payload
        run: |
          python - <<'PY'
          import json, pathlib, datetime
          path = pathlib.Path('governance/control/instruction-log.jsonl')
          events = []
          if path.exists():
              for line in path.read_text().splitlines():
                  if line.strip():
                      events.append(json.loads(line))
          payload = {"events": events}
          pathlib.Path('governance/control/instruction-log.json').write_text(json.dumps(payload, indent=2), encoding='utf-8')
          PY
      - name: Generate manifest
        run: |
          python -m tools.governance.manifest_builder \
            --artifact-type instruction-log \
            --layer L4 \
            --custodian "api-governance" \
            --context-uri "https://github.com/${{ github.repository }}" \
            --payload governance/control/instruction-log.json \
            --payload-uri "s3://governance/${{ github.repository }}/control/instruction-log.json" \
            --schema-ref instruction_log.schema.json \
            --tags control instruction override \
            --extra-path governance/control/instruction-log.json \
            --output governance/control/manifest.json
      - name: Commit manifest
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(governance): append instruction log"
          file_pattern: governance/control/**
