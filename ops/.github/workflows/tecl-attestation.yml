name: Trusted Compute Attestation

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  collect-attestation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Collect runtime attestation
        run: |
          mkdir -p governance/compute
          cat <<'JSON' > governance/compute/attestation.json
          {
            "provider": "aws",
            "region": "us-east-1",
            "instance_type": "c7g.large",
            "boot_hash": "$(uuidgen | tr '[:upper:]' '[:lower:]')",
            "kernel_version": "$(uname -r)",
            "method": "simulated",
            "evidence": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "expires_at": "$(date -u -d '+24 hours' +%Y-%m-%dT%H:%M:%SZ)"
          }
          JSON
      - name: Generate manifest
        run: |
          python -m tools.governance.manifest_builder \
            --artifact-type trusted-execution \
            --layer L1 \
            --custodian "platform-security" \
            --context-uri "https://github.com/${{ github.repository }}" \
            --payload governance/compute/attestation.json \
            --payload-uri "s3://governance/${{ github.repository }}/compute/attestation.json" \
            --schema-ref tecl.schema.json \
            --tags tecl attestation nightly \
            --extra-json '{"compute_environment": {"provider": "aws", "region": "us-east-1", "instance_type": "c7g.large", "boot_hash": "captured"}, "attestation": {"method": "simulated", "evidence": "file://attestation.json", "expires_at": "24h"}}' \
            --output governance/compute/manifest.json
      - name: Commit manifest
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(governance): refresh TECL attestation"
          file_pattern: governance/compute/**
