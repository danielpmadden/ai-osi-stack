name: Governance Decision Summary Publication

on:
  schedule:
    - cron: '0 6 1 */3 *'
  workflow_dispatch:

jobs:
  publish-gds:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Assemble quarterly report
        run: |
          mkdir -p governance/deployment
          cat <<'MD' > governance/deployment/gds_report.md
          # Governance Decision Summary

          *Quarterly automated report generated by CI.*

          - Decision: Approve model promotion to production (status: approved)
          - Decision: Launch civic feedback portal (status: in-review)
          MD
          python - <<'PY'
          import json, pathlib, datetime
          now = datetime.datetime.utcnow()
          quarter = (now.month - 1) // 3 + 1
          data = {
              "reporting_period": f"Q{quarter} {now.year}",
              "metrics": [
                  {"name": "model_uptime", "value": "99.95", "unit": "%"},
                  {"name": "feedback_responses", "value": "128"}
              ],
              "decisions": [
                  {"title": "Approve model promotion", "status": "approved", "summary": "Met fairness guardrails"},
                  {"title": "Launch civic feedback portal", "status": "in-review", "summary": "Pending security review"}
              ]
          }
          pathlib.Path('governance/deployment/gds_payload.json').write_text(json.dumps(data, indent=2), encoding='utf-8')
          PY
      - name: Generate manifest
        run: |
          python -m tools.governance.manifest_builder \
            --artifact-type governance-decision-summary \
            --layer L7 \
            --custodian "governance-office" \
            --context-uri "https://github.com/${{ github.repository }}" \
            --payload governance/deployment/gds_payload.json \
            --payload-uri "s3://governance/${{ github.repository }}/deployment/gds_payload.json" \
            --schema-ref gds.schema.json \
            --tags gds quarterly metrics \
            --extra-path governance/deployment/gds_payload.json \
            --output governance/deployment/manifest.json
      - name: Commit manifest
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(governance): publish quarterly GDS"
          file_pattern: governance/deployment/**
