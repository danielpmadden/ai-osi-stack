name: Civic Charter Evidence

on:
  push:
    paths:
      - 'docs/charter/**'
      - '.github/workflows/charter-evidence.yml'
  workflow_dispatch:

jobs:
  build-charter-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc
      - name: Render charter PDF
        run: |
          mkdir -p governance/charter
          pandoc docs/charter/Charter.md -o governance/charter/civic_charter.pdf
      - name: Generate manifest
        run: |
          python -m tools.governance.manifest_builder \
            --artifact-type civic-charter \
            --layer L0 \
            --custodian "governance-office" \
            --context-uri "https://github.com/${{ github.repository }}" \
            --payload governance/charter/civic_charter.pdf \
            --payload-uri "s3://governance/${{ github.repository }}/charter/civic_charter.pdf" \
            --schema-ref civic_charter.schema.json \
            --tags charter civic mandate \
            --output governance/charter/manifest.json
      - name: Commit manifest
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(governance): update civic charter evidence"
          file_pattern: governance/charter/**
